define("bigba:widget/common/ui/search/search.js",function(require,exports,module){var CookieDataCenter=require("bigba:static/utils/CookieDataCenter.js"),AddressDataCenter=require("bigba:static/utils/AddressDataCenter.js"),resultTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="search-title">    <div class="search-desc">请确定您的地址</div></div><div class="search-list s-list">    <ul>        ');for(var i=0,len=data.length;len>i;i++){var item=data[i];_template_fun_array.push('            <li data-uid = "',"undefined"==typeof item.uid?"":baidu.template._encodeHTML(item.uid),'" data-link = "/waimai?qt=shoplist&lat=',"undefined"==typeof item.latitude?"":baidu.template._encodeHTML(item.latitude),"&lng=","undefined"==typeof item.longitude?"":baidu.template._encodeHTML(item.longitude),"&address=","undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),"&city_id=","undefined"==typeof city_id?"":baidu.template._encodeHTML(city_id),'" data-msg = "',"undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),"$","undefined"==typeof(item.address?item.address:"")?"":baidu.template._encodeHTML(item.address?item.address:""),"$","undefined"==typeof item.latitude?"":baidu.template._encodeHTML(item.latitude),"$","undefined"==typeof item.longitude?"":baidu.template._encodeHTML(item.longitude),"$","undefined"==typeof item.shopnum?"":baidu.template._encodeHTML(item.shopnum),"$","undefined"==typeof city_id?"":baidu.template._encodeHTML(city_id),'" data-name="',"undefined"==typeof decodeURIComponent(item.name)?"":baidu.template._encodeHTML(decodeURIComponent(item.name)),'">                <div class="addr addr-icon"></div>                <div class="addr addr-content">                    <p class="addr-name">',"undefined"==typeof item.name?"":baidu.template._encodeHTML(item.name),'</p>                    <p class="addr-desc">',"undefined"==typeof(item.address?item.address:"")?"":baidu.template._encodeHTML(item.address?item.address:""),"</p>                    "),item.shopnum&&0!==parseInt(item.shopnum,10)?_template_fun_array.push('                        <p class="addr-shop-num">',"undefined"==typeof item.shopnum?"":baidu.template._encodeHTML(item.shopnum),"家餐厅</p>                    "):_template_fun_array.push('                        <p class="addr-shop-num addr-no-open">暂无开通</p>                    '),_template_fun_array.push("                </div>            </li>        ")}_template_fun_array.push("    </ul></div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],historyTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="s-list search-list">    <ul>        ');for(var i=0,len=data.length;len>i;i++){var item=data[i];_template_fun_array.push('        <li data-link = "/waimai?qt=shoplist&lat=',"undefined"==typeof item.lat?"":baidu.template._encodeHTML(item.lat),"&lng=","undefined"==typeof item.lng?"":baidu.template._encodeHTML(item.lng),"&address=","undefined"==typeof decodeURIComponent(item.name)?"":baidu.template._encodeHTML(decodeURIComponent(item.name)),"&city_id=","undefined"==typeof decodeURIComponent(item.city_id)?"":baidu.template._encodeHTML(decodeURIComponent(item.city_id)),'" data-name="',"undefined"==typeof decodeURIComponent(item.name)?"":baidu.template._encodeHTML(decodeURIComponent(item.name)),'">                <div class="addr his-icon"></div>                <div class="addr addr-content">                    <p class="addr-name">',"undefined"==typeof decodeURIComponent(item.name)?"":baidu.template._encodeHTML(decodeURIComponent(item.name)),'</p>                    <p class="addr-desc">',"undefined"==typeof decodeURIComponent(item.address)?"":baidu.template._encodeHTML(decodeURIComponent(item.address)),"</p>                    "),item.shopnum&&0!==parseInt(item.shopnum,10)?_template_fun_array.push('                        <p class="addr-shop-num">',"undefined"==typeof item.shopnum?"":baidu.template._encodeHTML(item.shopnum),"家外卖餐厅</p>                    "):_template_fun_array.push('                        <p class="addr-shop-num addr-no-open">暂无开通</p>                    '),_template_fun_array.push("                </div>            </li>        ")}_template_fun_array.push('    </ul></div><div class="search-history-clear">    <a class="clear-btn">清空历史记录</a></div>'),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],sugTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div class="search-list s-list">    <ul>        ');for(var i=0,len=data.length;len>i;i++){var item=data[i];_template_fun_array.push('            <li data-name="',"undefined"==typeof item.name3?"":baidu.template._encodeHTML(item.name3),'">                <div class="addr addr-icon"></div>                <div class="addr addr-content">                    <p class="addr-name">',"undefined"==typeof item.name3?"":baidu.template._encodeHTML(item.name3),'</p>                    <p class="addr-desc">',"undefined"==typeof item.name1?"":baidu.template._encodeHTML(item.name1),"","undefined"==typeof item.name2?"":baidu.template._encodeHTML(item.name2),"","undefined"==typeof item.name3?"":baidu.template._encodeHTML(item.name3),"</p>                </div>            </li>        ")}_template_fun_array.push("    </ul></div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],emptyTmpl=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push("<p>此地点附近暂时没有外卖餐厅，努力覆盖中...</p>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],_historyHtml,Search=function(e,t){var a=function(){function e(e){$.extend(y,e)}function t(){y.$resultEl.addClass("mod-search-hide mod-search-container")}function a(){y.$resultEl.addClass("mod-search-hide")}function n(){for(var e=y.$resultEl.find(".s-list li"),t=y.$resultEl.offset().top,a=0,n=e.length;n>a;a++){var i=e.eq(a).offset().top,d=e.eq(a).outerHeight(!0),s=i-d-t;e.eq(a).attr("data-top",s)}}function i(){var e;y.$resultEl.empty().removeClass("mod-search-result mod-search-sug mod-search-empty").addClass("mod-search-history"),e=c(),e?(y.$resultEl.removeClass("mod-search-hide").append(e).show(),n()):y.$resultEl.addClass("mod-search-hide")}function d(){y.$resultEl.hide().empty().removeClass("mod-search-history").addClass("mod-search-hide")}function s(e){y.$resultEl.empty().removeClass("mod-search-hide mod-search-result mod-search-history mod-search-empty").addClass("mod-search-sug").append(e).show(),n(),m()}function l(e){y.$resultEl.empty(),y.$resultEl.removeClass("mod-search-hide mod-search-sug mod-search-history mod-search-empty"),y.$resultEl.addClass("mod-search-result"),y.$resultEl.append(e).show(),n(),m()}function r(){if(y.NOListLiJump)y.$hiddenSearchPOI.val("0-0"),a();else{var e=emptyTmpl();y.$resultEl.empty(),y.$resultEl.removeClass("mod-search-hide mod-search-sug mod-search-history mod-search-result"),y.$resultEl.addClass("mod-search-empty"),y.$resultEl.append(e).show(),m()}}function o(){$(".s-loading").removeClass("mod-search-hide")}function m(){$(".s-loading").addClass("mod-search-hide")}function u(e){e.preventDefault(),e.stopPropagation()}function c(){if(_historyHtml)return _historyHtml;var e=AddressDataCenter.getAll();return e&&e.length?_historyHtml=historyTmpl({data:e}):null}function p(e){var t=CookieDataCenter.getCity().code,e=e?e:y.$searchConEl.val(),a="";$.ajax({url:"http://map.baidu.com/su?wd="+e,type:"GET",dataType:"jsonp",data:{cid:t,type:0},success:function(t){var n=t.s||[];if(n.length>0){if(y.NOListLiJump){a="";var i=[];$.each(n,function(t,a){{var n=a.split("$")[3];n.replace(e,"<b>"+e+"</b>")}i.push({name1:a.split("$")[0],name2:a.split("$")[1],name3:a.split("$")[3]})}),a=sugTmpl({data:i})}else a="<div class='search-list s-list'><ul>",$.each(n,function(t,n){var i=n.split("$")[3],d="<i></i><span>"+i.replace(e,"<b>"+e+"</b>")+"</span>";a+="<li data-name='"+i+"'>"+d+"</li>"}),a+="</ul></div>";s(a)}}})}function _(e){o();var e=e?e:y.$searchConEl.val();statis&&statis.trackEvent("find","poisearch",e),addNStat({da_src:"findBk.searchBtn",da_act:"click",da_trd:"waimai"});var t="/waimai?qt=poisearch&from=pc&ie=utf-8&sug=0&tn=B_NORMAL_MAP&oue=1&res=1&c="+CookieDataCenter.getCity().code;$.ajax({type:"GET",url:t,dataType:"json",data:{wd:e,_t:+new Date},timeout:1e4,success:function(e){if(0==e.error_no)if(""==e.result.url)if(y.NOListLiJump&&1==e.result.content.length){var t=e.result.content[0].name||"",n=e.result.content[0].latitude||"0",i=e.result.content[0].longitude||"0";y.$searchConEl.val(t),y.$hiddenSearchPOI.val(n+"-"+i),a()}else{var d=resultTmpl({data:e.result.content,city_id:e.result.city_id});l(d)}else{var s=e.result.content[0]||{shopnum:0};if(s.shopnum){var o={};o.name=s.name,o.address=s.address,o.lat=s.latitude,o.lng=s.longitude,o.shopnum=s.shopnum,o.city_id=e.result.city_id,AddressDataCenter.add(o),y.NOListLiJump?(y.$searchConEl.val(o.name),y.$hiddenSearchPOI.val(o.lat+"-"+o.lng),a()):window.location.href=e.result.url}else r()}else r()},error:function(){r()}})}function f(){var e=y.$resultEl.find(".s-list");if(e.length>0){var t=e.find("li.s-on");if(t.length>0)return void t.click()}y.$searchConEl.val()&&_(y.$searchConEl.val())}function h(){var e,t=y.$resultEl.find(".s-list li");if(t.length>0){if(y.$resultEl.hasClass("mod-search-result")){if(t.size()<5)return}else if(t.size()<7)return;e=y.$resultEl.find(".s-list li.s-on").attr("data-top"),y.$resultEl.scrollTop(e)}}function v(e){var t=y.$searchConEl,n=y.$resultEl,s="show.history";y.showHistoryTrg&&(s=y.showHistoryTrg);var l="hide.history";y.hideHistoryTrg&&(l=y.hideHistoryTrg),$(e).on(s,function(){setTimeout(function(){i()},0)}),$(e).on(l,function(){setTimeout(function(){d()},0)}),n.on("blur",function(){this.hide()}),t.on("click",function(e){var a=t.val(),n=CookieDataCenter.getCity();0==a.length?n.hasaoi||i():p(a),e.stopPropagation()}),t.on("keydown",function(e){if(window.NOBLUR="NOPE",y.$hiddenSearchPOI&&y.$hiddenSearchPOI.val(""),13==e.which)return void f();if(38!=e.which)if(40!=e.which){var a=CookieDataCenter.getCity();setTimeout(function(){var e=t.val();0==e.length?a.hasaoi||i():p(e)},0)}else{var d=n.find(".s-list");if(d.length>0){var s=d.find("li.s-on");0==s.length||s.index()==d.find("li").length-1?(d.find("li:first").addClass("s-on"),s.removeClass("s-on")):(s.next("li").addClass("s-on"),s.removeClass("s-on"));var l=d.find("li.s-on"),r=l.attr("data-name");h(),r&&t.val(r)}}else{var d=n.find(".s-list");if(d.length>0){var s=d.find("li.s-on");0==s.length||0==s.index()?(d.find("li:last").addClass("s-on"),s.removeClass("s-on")):(s.prev("li").addClass("s-on"),s.removeClass("s-on"));var l=d.find("li.s-on"),r=l.attr("data-name");h(),r&&t.val(r)}}}),n.on("click",".s-list li",function(e){if(u(e),n.hasClass("mod-search-sug")){var t=$(e.currentTarget).data("name");return t&&y.$searchConEl.val(t),void _()}var a={},i=$(this).attr("data-msg"),s=$(this).attr("data-link");if(n.hasClass("mod-search-result")){if(y.NOListLiJump);else if($(this).find(".addr-shop-num").hasClass("addr-no-open"))return;var l=i.split("$");a.name=l[0],a.address=l[1],a.lat=l[2],a.lng=l[3],a.shopnum=l[4],a.city_id=l[5],AddressDataCenter.add(a)}if(y.NOListLiJump){for(var l=s.split("&"),r=[],o=0;o<l.length;o++){var m=l[o].split("=")[0],c=l[o].split("=")[1];r[m]=c}a.name=r.address,a.lat=r.lat,a.lng=r.lng,a.city_id=r.city_id,AddressDataCenter.add(a),y.$searchConEl.val(r.address),y.$hiddenSearchPOI.val(a.lat+"-"+a.lng),d()}else window.location.href=s}),n.on("mousedown",".s-list li",function(){window.NOBLUR="YES"}),n.on("click",".clear-btn",function(e){u(e),AddressDataCenter.clearAll(),_historyHtml=null,a(),n.empty()}),$(document).on("click",a),n.hover(function(){$(document).unbind("click",a)},function(){$(document).on("click",a)}),t.hover(function(){$(document).unbind("click",a)},function(){$(document).on("click",a)})}var y={$resultEl:null,$searchConEl:null,$searchBtn:null,showHistoryTrg:null,hideHistoryTrg:null,NOListLiJump:null,$hiddenSearchPOI:null};return{initOption:e,initHtml:t,bindEvent:v}}();a.initOption(t),a.initHtml(),a.bindEvent(e),a=null};module.exports={init:function(e){new Search(this,e)}}});